New Architutre: 

Start:

1. User clicks [Start Charging] button
   ↓
2. System asks: "📸 Take photo of your dashboard showing current kWh"
   ↓
3. User uploads photo (WhatsApp image message)
   ↓
4. Tesseract.js extracts reading: "1245.8 kWh"
   ↓
5. System confirms: "We detected: 1245.8 kWh - Is this correct?"
   [✓ Yes, Start] [✗ Retake Photo]
   ↓
6A. User clicks "Yes" → startSession() called with startReading: 1245.8
   ↓
6B. User clicks "Retake" → Back to step 2 (max 3 attempts)
   ↓
7. If 3 attempts fail → Manual entry fallback
   "Please TYPE the kWh reading: ____"
   ↓
8. Session starts with verified reading ✓

Stop:

1. User clicks [Stop Charging] button
   ↓
2. System asks: "📸 Take photo of dashboard showing FINAL kWh"
   ↓
3. User uploads photo
   ↓
4. Tesseract.js extracts: "1258.3 kWh"
   ↓
5. System confirms: "Final reading: 1258.3 kWh - Correct?"
   [✓ Yes, Stop] [✗ Retake Photo]
   ↓
6. User confirms → Calculate consumption:
   END (1258.3) - START (1245.8) = 12.5 kWh
   ↓
7. Validation check:
   - Is 12.5 kWh reasonable for session duration? ✓
   - Is it within battery capacity? ✓
   ↓
8. Calculate bill: 12.5 × ₹12/kWh = ₹150
   ↓
9. stopSession() called with actualKwh: 12.5
   




New files chagnes:

src/
├── services/
│   ├── session.ts (EXISTING - minimal changes)
│   ├── photo-verification.ts (NEW - all photo logic here)
│   └── whatsapp.ts (EXISTING - minimal changes)
├── controllers/
│   └── booking.ts (EXISTING - minimal changes)
└── utils/
    └── ocr-processor.ts (NEW - Tesseract wrapper)




┌──────────────────────────────────────────────────────────┐
│                    IDLE STATE                            │
│         (User has active reservation)                    │
└──────────────────┬───────────────────────────────────────┘
                   │
          User clicks [Start Charging]
                   │
                   ▼
┌──────────────────────────────────────────────────────────┐
│              AWAITING_START_PHOTO                        │
│  "📸 Take photo of dashboard showing current kWh"        │
│  State: { waitingFor: 'start_photo', attemptCount: 0 }  │
└──────────────────┬───────────────────────────────────────┘
                   │
            Photo uploaded
                   │
                   ▼
┌──────────────────────────────────────────────────────────┐
│              PROCESSING_START_PHOTO                      │
│  Tesseract.js extracts reading                           │
│  "Detected: 1245.8 kWh"                                  │
└──────────────────┬───────────────────────────────────────┘
                   │
       ┌───────────┴───────────┐
       │                       │
   User confirms          User retries
       │                       │
       ▼                       ▼
┌─────────────────┐   ┌───────────────────┐
│ START_VERIFIED  │   │ attemptCount += 1 │
│ startReading    │   │ If < 3: Retry     │
│ saved           │   │ If = 3: Manual    │
└────────┬────────┘   └───────────────────┘
         │
         ▼
┌──────────────────────────────────────────────────────────┐
│              CHARGING_IN_PROGRESS                        │
│  sessionService.startSession() called                    │
│  Normal session tracking runs...                         │
└──────────────────┬───────────────────────────────────────┘
                   │
          User clicks [Stop Charging]
                   │
                   ▼
┌──────────────────────────────────────────────────────────┐
│              AWAITING_END_PHOTO                          │
│  "📸 Take photo showing FINAL kWh reading"               │
│  State: { waitingFor: 'end_photo', attemptCount: 0 }    │
└──────────────────┬───────────────────────────────────────┘
                   │
            Photo uploaded
                   │
                   ▼
┌──────────────────────────────────────────────────────────┐
│              PROCESSING_END_PHOTO                        │
│  Extract final reading: 1258.3 kWh                       │
│  Calculate: 1258.3 - 1245.8 = 12.5 kWh                  │
└──────────────────┬───────────────────────────────────────┘
                   │
       ┌───────────┴───────────┐
       │                       │
   User confirms          User retries
       │                       │
       ▼                       ▼
┌─────────────────┐   ┌───────────────────┐
│ END_VERIFIED    │   │ attemptCount += 1 │
│ Calculate bill  │   │ Retry logic       │
└────────┬────────┘   └───────────────────┘
         │
         ▼
┌──────────────────────────────────────────────────────────┐
│              BILLING_COMPLETE                            │
│  Bill: 12.5 kWh × ₹12 = ₹150                            │
│  sessionService.stopSession(actualKwh: 12.5)             │
│                             │                │
└─────────────────────────────────────────────────────────┘


retry message:

📸 Let's try again!

Please retake the photo with:
- Better lighting
- Clear focus on the kWh display
- No glare or reflections

(Attempt 2 of 3)












Sanity Checks (Prevent Fraud/Errors):
Check 1: Reading Direction
END reading MUST be > START reading
If not → Flag error: "End reading cannot be less than start"

Check 2: Reasonable Consumption
kWh consumed must be between 5-100 kWh
If outside → Flag: "Reading seems unusual"

Check 3: Duration Match
12.5 kWh in 45 min @ 50kW charger = Realistic ✓
60 kWh in 10 min = Impossible ❌

Check 4: Battery Capacity
Nexon battery = 30 kWh max
If user claims 50 kWh → Impossible ❌

Check 5: Physics Check
(Duration in hours × Charger power × 0.9 efficiency) = Max possible
If claimed > max possible → Flag suspicious





