New Architutre: 

Start:

1. User clicks [Start Charging] button
   â†“
2. System asks: "ğŸ“¸ Take photo of your dashboard showing current kWh"
   â†“
3. User uploads photo (WhatsApp image message)
   â†“
4. Tesseract.js extracts reading: "1245.8 kWh"
   â†“
5. System confirms: "We detected: 1245.8 kWh - Is this correct?"
   [âœ“ Yes, Start] [âœ— Retake Photo]
   â†“
6A. User clicks "Yes" â†’ startSession() called with startReading: 1245.8
   â†“
6B. User clicks "Retake" â†’ Back to step 2 (max 3 attempts)
   â†“
7. If 3 attempts fail â†’ Manual entry fallback
   "Please TYPE the kWh reading: ____"
   â†“
8. Session starts with verified reading âœ“

Stop:

1. User clicks [Stop Charging] button
   â†“
2. System asks: "ğŸ“¸ Take photo of dashboard showing FINAL kWh"
   â†“
3. User uploads photo
   â†“
4. Tesseract.js extracts: "1258.3 kWh"
   â†“
5. System confirms: "Final reading: 1258.3 kWh - Correct?"
   [âœ“ Yes, Stop] [âœ— Retake Photo]
   â†“
6. User confirms â†’ Calculate consumption:
   END (1258.3) - START (1245.8) = 12.5 kWh
   â†“
7. Validation check:
   - Is 12.5 kWh reasonable for session duration? âœ“
   - Is it within battery capacity? âœ“
   â†“
8. Calculate bill: 12.5 Ã— â‚¹12/kWh = â‚¹150
   â†“
9. stopSession() called with actualKwh: 12.5
   




New files chagnes:

src/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ session.ts (EXISTING - minimal changes)
â”‚   â”œâ”€â”€ photo-verification.ts (NEW - all photo logic here)
â”‚   â””â”€â”€ whatsapp.ts (EXISTING - minimal changes)
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ booking.ts (EXISTING - minimal changes)
â””â”€â”€ utils/
    â””â”€â”€ ocr-processor.ts (NEW - Tesseract wrapper)




â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    IDLE STATE                            â”‚
â”‚         (User has active reservation)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
          User clicks [Start Charging]
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AWAITING_START_PHOTO                        â”‚
â”‚  "ğŸ“¸ Take photo of dashboard showing current kWh"        â”‚
â”‚  State: { waitingFor: 'start_photo', attemptCount: 0 }  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
            Photo uploaded
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PROCESSING_START_PHOTO                      â”‚
â”‚  Tesseract.js extracts reading                           â”‚
â”‚  "Detected: 1245.8 kWh"                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                       â”‚
   User confirms          User retries
       â”‚                       â”‚
       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ START_VERIFIED  â”‚   â”‚ attemptCount += 1 â”‚
â”‚ startReading    â”‚   â”‚ If < 3: Retry     â”‚
â”‚ saved           â”‚   â”‚ If = 3: Manual    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CHARGING_IN_PROGRESS                        â”‚
â”‚  sessionService.startSession() called                    â”‚
â”‚  Normal session tracking runs...                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
          User clicks [Stop Charging]
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AWAITING_END_PHOTO                          â”‚
â”‚  "ğŸ“¸ Take photo showing FINAL kWh reading"               â”‚
â”‚  State: { waitingFor: 'end_photo', attemptCount: 0 }    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
            Photo uploaded
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PROCESSING_END_PHOTO                        â”‚
â”‚  Extract final reading: 1258.3 kWh                       â”‚
â”‚  Calculate: 1258.3 - 1245.8 = 12.5 kWh                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                       â”‚
   User confirms          User retries
       â”‚                       â”‚
       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ END_VERIFIED    â”‚   â”‚ attemptCount += 1 â”‚
â”‚ Calculate bill  â”‚   â”‚ Retry logic       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BILLING_COMPLETE                            â”‚
â”‚  Bill: 12.5 kWh Ã— â‚¹12 = â‚¹150                            â”‚
â”‚  sessionService.stopSession(actualKwh: 12.5)             â”‚
â”‚                             â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


retry message:

ğŸ“¸ Let's try again!

Please retake the photo with:
- Better lighting
- Clear focus on the kWh display
- No glare or reflections

(Attempt 2 of 3)












Sanity Checks (Prevent Fraud/Errors):
Check 1: Reading Direction
END reading MUST be > START reading
If not â†’ Flag error: "End reading cannot be less than start"

Check 2: Reasonable Consumption
kWh consumed must be between 5-100 kWh
If outside â†’ Flag: "Reading seems unusual"

Check 3: Duration Match
12.5 kWh in 45 min @ 50kW charger = Realistic âœ“
60 kWh in 10 min = Impossible âŒ

Check 4: Battery Capacity
Nexon battery = 30 kWh max
If user claims 50 kWh â†’ Impossible âŒ

Check 5: Physics Check
(Duration in hours Ã— Charger power Ã— 0.9 efficiency) = Max possible
If claimed > max possible â†’ Flag suspicious





